On PC :
# Run PowerShell as Administrator
New-NetFirewallRule -DisplayName "PostgreSQL" -Direction Inbound -LocalPort 5432 -Protocol TCP -Action Allow

-- Create a function to notify on client changes
CREATE OR REPLACE FUNCTION notify_client_change()
RETURNS TRIGGER AS $$
BEGIN
    -- Notify with client ID
    IF (TG_OP = 'INSERT') THEN
        PERFORM pg_notify('client_changes', json_build_object(
            'action', 'INSERT',
            'client_id', NEW.id,
            'image_path', NEW.image_path
        )::text);
        RETURN NEW;
    ELSIF (TG_OP = 'UPDATE') THEN
        -- Only notify if image_path changed or embedding is null
        IF (OLD.image_path IS DISTINCT FROM NEW.image_path) THEN
            PERFORM pg_notify('client_changes', json_build_object(
                'action', 'UPDATE',
                'client_id', NEW.id,
                'image_path', NEW.image_path
            )::text);
        END IF;
        RETURN NEW;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- Create trigger
DROP TRIGGER IF EXISTS client_change_trigger ON clients;
CREATE TRIGGER client_change_trigger
AFTER INSERT OR UPDATE ON clients
FOR EACH ROW
EXECUTE FUNCTION notify_client_change();

-- Grant necessary permissions
GRANT ALL ON clients TO gym_user;
GRANT ALL ON face_embeddings TO gym_user;





//////////////////////////////////////////////


-- Create gym sessions table to track entrance and exit times
CREATE TABLE IF NOT EXISTS public.gym_sessions
(
    id bigserial NOT NULL,
    client_id bigint NOT NULL,
    entrance_time timestamp without time zone NOT NULL,
    exit_time timestamp without time zone,
    locker_number integer,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    FOREIGN KEY (client_id) REFERENCES clients(id) ON DELETE CASCADE
);

-- Create index for faster queries
CREATE INDEX idx_gym_sessions_client_id ON gym_sessions(client_id);
CREATE INDEX idx_gym_sessions_entrance_time ON gym_sessions(entrance_time);
CREATE INDEX idx_gym_sessions_exit_time ON gym_sessions(exit_time);

-- Grant permissions
GRANT ALL PRIVILEGES ON gym_sessions TO gym_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO gym_user;