On PC :
# Run PowerShell as Administrator
New-NetFirewallRule -DisplayName "PostgreSQL" -Direction Inbound -LocalPort 5432 -Protocol TCP -Action Allow

-- Create a function to notify on client changes
CREATE OR REPLACE FUNCTION notify_client_change()
RETURNS TRIGGER AS $$
BEGIN
    -- Notify with client ID
    IF (TG_OP = 'INSERT') THEN
        PERFORM pg_notify('client_changes', json_build_object(
            'action', 'INSERT',
            'client_id', NEW.id,
            'image_path', NEW.image_path
        )::text);
        RETURN NEW;
    ELSIF (TG_OP = 'UPDATE') THEN
        -- Only notify if image_path changed or embedding is null
        IF (OLD.image_path IS DISTINCT FROM NEW.image_path) THEN
            PERFORM pg_notify('client_changes', json_build_object(
                'action', 'UPDATE',
                'client_id', NEW.id,
                'image_path', NEW.image_path
            )::text);
        END IF;
        RETURN NEW;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- Create trigger
DROP TRIGGER IF EXISTS client_change_trigger ON clients;
CREATE TRIGGER client_change_trigger
AFTER INSERT OR UPDATE ON clients
FOR EACH ROW
EXECUTE FUNCTION notify_client_change();

-- Grant necessary permissions
GRANT ALL ON clients TO gym_user;
GRANT ALL ON face_embeddings TO gym_user;





//////////////////////////////////////////////


-- Create gym sessions table to track entrance and exit times
CREATE TABLE IF NOT EXISTS public.gym_sessions
(
    id bigserial NOT NULL,
    client_id bigint NOT NULL,
    entrance_time timestamp without time zone NOT NULL,
    exit_time timestamp without time zone,
    locker_number integer,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    FOREIGN KEY (client_id) REFERENCES clients(id) ON DELETE CASCADE
);

-- Create index for faster queries
CREATE INDEX idx_gym_sessions_client_id ON gym_sessions(client_id);
CREATE INDEX idx_gym_sessions_entrance_time ON gym_sessions(entrance_time);
CREATE INDEX idx_gym_sessions_exit_time ON gym_sessions(exit_time);

-- Grant permissions
GRANT ALL PRIVILEGES ON gym_sessions TO gym_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO gym_user;

cmake -D CMAKE_BUILD_TYPE=RELEASE \
    -D CMAKE_INSTALL_PREFIX=/usr/local \
    -D OPENCV_EXTRA_MODULES_PATH=~/opencv_contrib/modules \
    -D ENABLE_NEON=ON \
    -D WITH_GSTREAMER=ON \
    -D WITH_GSTREAMER_0_10=OFF \
    -D WITH_LIBV4L=ON \
    -D WITH_V4L=ON \
    -D WITH_TBB=ON \
    -D WITH_OPENMP=ON \
    -D BUILD_TESTS=OFF \
    -D BUILD_PERF_TESTS=OFF \
    -D BUILD_EXAMPLES=OFF \
    -D OPENCV_ENABLE_NONFREE=ON \
    -D PYTHON3_EXECUTABLE=/usr/bin/python3 \
    -D PYTHON_INCLUDE_DIR=/usr/include/python3.* \
    -D PYTHON_LIBRARY=/usr/lib/aarch64-linux-gnu/libpython3.*.so \
    -D BUILD_opencv_python3=ON \
    ..





    # Simpler configuration
cmake -D CMAKE_BUILD_TYPE=RELEASE \
    -D CMAKE_INSTALL_PREFIX=/usr/local \
    -D OPENCV_EXTRA_MODULES_PATH=~/opencv_build/opencv_contrib-4.12.0/modules \
    -D WITH_GSTREAMER=ON \
    -D ENABLE_NEON=ON \
    -D BUILD_TESTS=OFF \
    -D BUILD_EXAMPLES=OFF \
    ..



    cmake -D CMAKE_BUILD_TYPE=RELEASE \
    -D CMAKE_INSTALL_PREFIX=/usr/local \
    -D OPENCV_EXTRA_MODULES_PATH=~/opencv_build/opencv_contrib-4.12.0/modules \
    -D ENABLE_NEON=ON \
    -D WITH_GSTREAMER=ON \
    -D VIDEOIO_ENABLE_PLUGINS=OFF \
    -D WITH_LIBV4L=ON \
    -D WITH_V4L=ON \
    -D WITH_TBB=ON \
    -D BUILD_TESTS=OFF \
    -D BUILD_PERF_TESTS=OFF \
    -D BUILD_EXAMPLES=OFF \
    -D OPENCV_ENABLE_NONFREE=ON \
    -D BUILD_opencv_python3=ON \
    -D PYTHON3_EXECUTABLE=$(which python3) \
    -D PYTHON3_NUMPY_INCLUDE_DIRS=$(python3 -c "import numpy; print(numpy.get_include())") \
    -D OPENCV_PYTHON3_VERSION=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')") \
    ..


    [Unit]
Description=RetinaFace Detection Service
After=network.target

[Service]
Type=simple
User=orangepi
WorkingDirectory=/home/orangepi/Projects/GymController
ExecStart=/usr/bin/python3 /home/orangepi/Projects/GymController/RetinaFaceL.py --model_path model/retinafacefp.rknn --db_host 192.168.1.3
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target